<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENSHRINE TOWER - 1面表示パズル</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #1c2331; 
            margin: 0;
            padding: 20px;
            color: #ffffff;
        }

        #game-container {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            background-color: #2d3a4c;
            border-radius: 8px;
            border: 4px solid #f4d03f;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        h1 {
            font-family: 'Noto Sans JP', sans-serif;
            color: #f4d03f;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em; 
            letter-spacing: 5px; 
            text-shadow: 0 0 5px rgba(244, 208, 63, 0.5);
            font-weight: 900;
        }

        section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #f4d03f;
            border-radius: 5px; 
            background-color: #2d3a4c;
            box-shadow: none;
        }

        h2 {
            font-family: 'Noto Sans JP', sans-serif;
            color: #ffffff;
            font-size: 1.5em;
            margin-bottom: 15px;
            border-bottom: 1px solid #f4d03f;
            padding-bottom: 5px;
            text-align: center;
            font-weight: 700;
        }
        
        .rules {
            margin-top: -10px;
        }

        .rules h3 {
            font-size: 1.25em;
            color: #f4d03f;
            margin-top: 25px;
            margin-bottom: 10px;
            border-bottom: 2px solid #f4d03f;
            padding-bottom: 5px;
            font-weight: 700;
            text-align: left;
        }
        .rules h3:first-of-type {
            margin-top: 0;
        }

        .rules ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .rules li {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #3c4757;
            border-left: 5px solid #f4d03f;
            border-radius: 3px;
            line-height: 1.6;
            font-size: 0.95em;
            color: #ffffff;
        }

        .rules strong {
            color: #f4d03f;
            font-weight: 700;
        }
        
        /* --- ステップアイコン --- */
        .rule-step-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px; 
            height: 30px;
            background-color: #f4d03f;
            color: #1c2331;
            border-radius: 50%;
            font-weight: 900;
            font-size: 1.2em;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
            margin-top: 5px; 
        }
        /* ----------------------- */

        .rules i.fa-solid {
            margin-right: 8px;
            color: #f4d03f;
        }
        
        /* --- ルールセクション内ボタン風要素のスタイル --- */
        .rule-button-visual {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            margin: 0 2px;
            background-color: #4a576c;
            border: 1px solid #f4d03f;
            border-radius: 5px;
            color: #f4d03f;
            font-weight: 700;
            font-size: 0.9em;
            vertical-align: middle;
            user-select: none; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            white-space: nowrap; 
            padding: 5px;
            line-height: 1;
        }
        
        .rule-button-visual.global-rotate-rule-button {
            font-size: 0.7em; 
            width: 50px; 
            white-space: normal;
            text-align: center;
            line-height: 1.2;
            padding: 3px;
        }
        
        .rule-icon-group {
            flex-shrink: 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
        
        .rule-text-content {
            flex-grow: 1;
            padding-top: 5px;
        }
        .rule-text-content p {
            margin: 0;
        }

        /* 謎解きステージ */
        #puzzle-stage {
            display: flex;
            flex-direction: column-reverse; /* 下から積む */
            align-items: center;
            gap: 5px;
            padding-top: 10px;
            min-height: 600px;
        }

        .box-wrapper {
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 450px; 
            transition: transform 0.3s ease;
            justify-content: space-between;
        }

        /* 箱の表示部分 (画像コンテナ) */
        .box-display {
            width: 100%; 
            max-width: 180px; 
            height: 100px;
            margin: 0 5px; 
            border: 2px solid #5d6d7e;
            background-color: #d8d8d8; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
            padding: 0;
        }
        .box-display img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 土台スタイル */
        .base-wrapper {
            justify-content: center;
            gap: 5px;
        }
        .base-box-display {
            flex-grow: 1;
            display: flex;
            max-width: 180px;
        }
        .base-box {
            flex-grow: 1;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f4d03f !important;
            color: #1c2331 !important;
            font-size: 1.1em;
            cursor: default;
            margin: 0 !important;
            border: 2px solid #f4d03f;
            overflow: hidden; 
            padding: 0;
        }
        .base-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 操作ボタン */
        .swap-button {
            width: 40px;
            height: 40px;
            padding: 0;
            background-color: #4a576c;
            border: 1px solid #f4d03f;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Noto Sans Sans JP', sans-serif;
            font-size: 1.1em;
            color: #f4d03f;
            transition: background-color 0.15s;
            line-height: 1;
        }
        .swap-button:hover {
            background-color: #5d6d7e;
        }
        .swap-button:disabled {
            opacity: 0.3;
            cursor: default;
            border-color: #5d6d7e;
            color: #5d6d7e;
        }
        
        .rotate-button {
            font-size: 1.1em; 
            font-weight: bold;
        }
        
        .global-rotate-button {
            width: 60px; 
            height: 60px; 
            padding: 5px;
            font-size: 0.9em; 
            white-space: normal; 
            line-height: 1.2; 
            display: flex; 
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 8px; 
        }

        /* アクションボタン */
        .action-button {
            display: block;
            width: fit-content;
            margin: 20px auto 10px;
            padding: 10px 20px;
            font-size: 1.1em;
            color: #1c2331;
            background-color: #f4d03f;
            border: 2px solid #e6b800;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            font-family: 'Noto Sans JP', sans-serif;
            font-weight: 700;
        }
        .action-button:hover {
            background-color: #e6b800;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        /* モーダル共通 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #2d3a4c;
            padding: 40px;
            border: 5px solid #f4d03f;
            width: 80%;
            max-width: 400px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5), 0 0 15px rgba(244, 208, 63, 0.5);
            color: #ffffff;
        }

        .modal-answer-char {
            font-size: 3em;
            font-weight: 900;
            color: #f4d03f;
            margin-bottom: 20px;
            display: block;
            font-family: 'Noto Sans JP', sans-serif;
            text-shadow: 0 0 8px rgba(244, 208, 63, 0.8);
        }
        
        .modal-hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>ENSHRINE TOWER</h1>

        <section id="rule-section">
            <h2>進め方と操作方法</h2>
            <div class="rules">
                
                <h3>進め方</h3>
                <ul>
                    <li style="align-items: flex-start;">
                        <div class="rule-step-icon">1</div>
                        <div class="rule-text-content" style="padding-top: 0;">
                            <p>本来は箱の側面を観察しながら、法則を推測し、箱を重ねていきますが、今回は箱ではなく、箱の側面の情報を観察し、箱を正しく並び替えましょう。</p>
                        </div>
                    </li>
                    <li style="align-items: flex-start;">
                        <div class="rule-step-icon">2</div>
                        <div class="rule-text-content" style="padding-top: 0;">
                            <p>箱を正しく並び替えたら、<strong>判定ボタン</strong>を押しましょう。正解ならば最後の答えが表示されます。</p>
                        </div>
                    </li>
                </ul>

                <h3>操作方法</h3>
                <ul>
                    <li style="align-items: center;">
                        <div class="rule-icon-group" style="gap: 5px;">
                            <span class="rule-button-visual">▲</span>
                            <span class="rule-button-visual">▼</span>
                        </div>
                        <div class="rule-text-content">
                            箱の<span style="color: #f4d03f;">位置を上下に入れ替える。</span>
                        </div>
                    </li>
                    <li>
                        <div class="rule-icon-group" style="gap: 5px;">
                            <span class="rule-button-visual">左</span>
                            <span class="rule-button-visual">右</span>
                        </div>
                        <div class="rule-text-content">
                            箱を<span style="color: #f4d03f;">左右90度回転</span>させる。
                        </div>
                    </li>
                    <li>
                        <div class="rule-icon-group" style="gap: 5px;">
                            <span class="rule-button-visual global-rotate-rule-button">すべて<br>左</span>
                            <span class="rule-button-visual global-rotate-rule-button">すべて<br>右</span>
                        </div>
                        <div class="rule-text-content">
                            土台と<span style="color: #f4d03f;">箱すべて左右90度回転</span>させる。
                        </div>
                    </li>
                </ul>
            </div>
        </section>

        <div id="stage-area" style="padding: 0 20px 20px; border: none; margin-bottom: 20px;">
            <div id="puzzle-stage">
                <!-- 箱と土台がJavaScriptで挿入されます -->
            </div>
            <button class="action-button" id="check-solution-button">判定</button>
        </div>

        <section id="result-area" style="display: none;">
            <h2>結果</h2>
            <p id="result-text" style="text-align: center; font-size: 1.3em; color: #ffffff; min-height: 50px;"></p>
        </section>
    </div>

    <!-- モーダルウィンドウ (正誤判定・最終解答表示用) -->
    <div id="check-result-modal" class="modal modal-hidden">
        <div class="modal-content">
            <h3 id="result-modal-title"></h3>
            <span id="result-modal-icon" class="modal-answer-char" style="font-size: 4em; margin-bottom: 0;"></span>
            <p id="result-modal-message" style="color: #ffffff; margin-top: 10px; line-height: 1.5;"></p>
            <button id="result-modal-close-button" class="action-button" style="margin-top: 20px;">閉じる</button>
        </div>
    </div>

    <div id="answer-modal" class="modal modal-hidden">
        <div class="modal-content">
            <h3>最終解答</h3>
            <span id="modal-char" class="modal-answer-char"></span>
            <p id="modal-message" style="color: #ffffff;"></p>
            <button id="modal-finish-button" class="action-button">ゲームクリア！</button>
        </div>
    </div>

    <script>
        // 謎解きデータ定義 (bottomCharのみが正解判定に必要)
        const BOX_DATA = {
            "box1": { bottomChar: "こ" }, 
            "box2": { bottomChar: "た" },
            "box3": { bottomChar: "え" },
            "box4": { bottomChar: "は" },
            "box5": { bottomChar: "ま" },
            "box6": { bottomChar: "て" },
            "box7": { bottomChar: "ん" },
            "box8": { bottomChar: "ろ" },
            "box9": { bottomChar: "う" }
        };

        const CORRECT_ORDER = ["box1", "box2", "box3", "box4", "box5", "box6", "box7", "box8", "box9"];
        const CORRECT_FINAL_FACE_INDEX = 1; // 最終的に正面に表示されるべき面 (Face 2 = Index 1)
        const FINAL_ANSWER_TEXT = "こたえはまてんろう"; 

        // ゲームの状態
        let globalRotation = 0; // 0-3: 土台による全体回転オフセット
        // currentStack: [{ id: 'boxX', rotation: 0-3 }] の配列 (Bottom to Top)
        let currentStack = []; 
        
        // --- ユーティリティ ---
        
        // 画像URLを生成 (ファイル名規則: {itemId}_face{faceIndex}.png)
        function getImageUrl(itemId, faceIndex) {
            return `${itemId}_face${faceIndex}.png`; 
        }

        // 配列をシャッフル
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- 初期化 ---
        function initGame() {
            // 初期スタックの生成 (ランダムな順番と初期回転)
            let boxIds = Object.keys(BOX_DATA);
            shuffleArray(boxIds);
            
            currentStack = boxIds.map((id) => ({
                id: id, 
                rotation: Math.floor(Math.random() * 4), 
            }));
            
            globalRotation = Math.floor(Math.random() * 4); 

            renderStack();

            document.getElementById('check-solution-button').addEventListener('click', checkSolution);
            document.getElementById('result-modal-close-button').addEventListener('click', closeResultModal);
        }

        // --- レンダリング ---
        function renderStack() {
            const stage = document.getElementById('puzzle-stage');
            stage.innerHTML = ''; 

            // 土台の描画
            const baseWrapper = document.createElement('div');
            baseWrapper.classList.add('box-wrapper', 'base-wrapper');

            const baseRotateLeftButton = createGlobalRotateButton('すべて<br>左', rotateAllBoxesLeft);
            const baseRotateRightButton = createGlobalRotateButton('すべて<br>右', rotateAllBoxesRight);

            const baseDisplay = document.createElement('div');
            baseDisplay.classList.add('base-box-display');
            
            const baseBox = document.createElement('div');
            baseBox.classList.add('base-box');
            
            // 画像挿入
            const baseImage = document.createElement('img');
            baseImage.src = getImageUrl("base", globalRotation);
            baseBox.appendChild(baseImage);
            
            baseDisplay.appendChild(baseBox);
            baseWrapper.appendChild(baseRotateLeftButton); 
            baseWrapper.appendChild(baseDisplay);
            baseWrapper.appendChild(baseRotateRightButton); 
            stage.appendChild(baseWrapper);

            // 9つの箱の描画 (Bottom to Top)
            for (let i = 0; i < currentStack.length; i++) {
                const boxInfo = currentStack[i];
                
                const wrapper = document.createElement('div');
                wrapper.classList.add('box-wrapper');
                wrapper.dataset.index = i;
                
                const downButton = createSwapButton('▼', i, i === 0, swapBoxes);
                const rotateLeftButton = createRotateButton('左', i, rotateIndividualBoxLeft);
                const rotateRightButton = createRotateButton('右', i, rotateIndividualBoxRight);
                const upButton = createSwapButton('▲', i, i === currentStack.length - 1, swapBoxes);

                // 現在表示すべき面を計算: (個別回転 + 全体回転オフセット) % 4
                const currentMainFaceIndex = (boxInfo.rotation + globalRotation) % 4;

                const boxDisplay = document.createElement('div');
                boxDisplay.classList.add('box-display');
                
                // 画像挿入
                const boxImage = document.createElement('img');
                boxImage.src = getImageUrl(boxInfo.id, currentMainFaceIndex);
                boxDisplay.appendChild(boxImage);
                
                boxDisplay.title = `${boxInfo.id.toUpperCase()} - 面${currentMainFaceIndex + 1}`;
                
                wrapper.appendChild(downButton);
                wrapper.appendChild(rotateLeftButton);
                wrapper.appendChild(boxDisplay);
                wrapper.appendChild(rotateRightButton);
                wrapper.appendChild(upButton);
                stage.appendChild(wrapper);
            }
        }

        // ボタン生成ヘルパー関数 (Swap)
        function createSwapButton(text, index, isDisabled, handler) {
            const button = document.createElement('button');
            button.classList.add('swap-button');
            button.textContent = text; 
            button.dataset.index = index;
            button.disabled = isDisabled;
            button.addEventListener('click', handler);
            return button;
        }

        // ボタン生成ヘルパー関数 (個別回転)
        function createRotateButton(text, index, handler) {
            const button = createSwapButton(text, index, false, handler);
            button.classList.add('rotate-button');
            return button;
        }

        // ボタン生成ヘルパー関数 (全体回転)
        function createGlobalRotateButton(htmlText, handler) {
            const button = document.createElement('button');
            button.classList.add('swap-button', 'global-rotate-button');
            button.innerHTML = htmlText;
            button.addEventListener('click', handler);
            return button;
        }

        // --- 操作 ---
        
        // 隣接する箱の入れ替え
        function swapBoxes(e) {
            const indexA = parseInt(e.currentTarget.dataset.index);
            const direction = e.currentTarget.textContent === '▲' ? 1 : -1;
            const indexB = indexA + direction;

            if (indexB >= 0 && indexB < currentStack.length) {
                [currentStack[indexA], currentStack[indexB]] = [currentStack[indexB], currentStack[indexA]];
                renderStack();
            }
        }
        
        // 個別の箱の右回転
        function rotateIndividualBoxRight(e) {
            const index = parseInt(e.currentTarget.dataset.index);
            if (index >= 0 && index < currentStack.length) {
                currentStack[index].rotation = (currentStack[index].rotation + 1) % 4;
                renderStack();
            }
        }

        // 個別の箱の左回転
        function rotateIndividualBoxLeft(e) {
            const index = parseInt(e.currentTarget.dataset.index);
            if (index >= 0 && index < currentStack.length) {
                currentStack[index].rotation = (currentStack[index].rotation - 1 + 4) % 4;
                renderStack();
            }
        }

        // 全ての箱の右回転
        function rotateAllBoxesRight() {
            globalRotation = (globalRotation + 1) % 4;
            renderStack();
        }

        // 全ての箱の左回転
        function rotateAllBoxesLeft() {
            globalRotation = (globalRotation - 1 + 4) % 4;
            renderStack();
        }

        // --- 判定ロジック ---

        function checkSolution() {
            // 1. 順番チェック
            let isOrderCorrect = true;
            for (let i = 0; i < currentStack.length; i++) {
                if (currentStack[i].id !== CORRECT_ORDER[i]) {
                    isOrderCorrect = false;
                    break;
                }
            }
            
            // 2. 回転状態チェック
            const TARGET_FACE_INDEX = CORRECT_FINAL_FACE_INDEX;
            let isRotationCorrect = true;

            for (let i = 0; i < currentStack.length; i++) {
                // 現在の正面表示面: (個別回転 + 全体回転オフセット) % 4
                const currentDisplayedFace = (currentStack[i].rotation + globalRotation) % 4;
                
                if (currentDisplayedFace !== TARGET_FACE_INDEX) {
                    isRotationCorrect = false;
                    break;
                }
            }
            
            if (isOrderCorrect && isRotationCorrect) {
                showResultModal(true);
                document.getElementById('check-solution-button').style.display = 'none';
            } else {
                showResultModal(false, '残念！まだどこかが違います。');
            }
        }

        // --- 判定結果モーダル表示 ---
        function showResultModal(isCorrect, message) {
            const modal = document.getElementById('check-result-modal');
            const title = document.getElementById('result-modal-title');
            const icon = document.getElementById('result-modal-icon');
            const msg = document.getElementById('result-modal-message');
            const closeButton = document.getElementById('result-modal-close-button');

            title.textContent = isCorrect ? '正解！' : '不正解';
            
            if (isCorrect) {
                icon.innerHTML = `<span style="font-size: 1.5em; text-shadow: none;">${FINAL_ANSWER_TEXT}</span>`; 
                icon.style.color = '#f4d03f';
                msg.innerHTML = 'コンプリートサイトに戻り、最後の答えを入力しましょう。';
                closeButton.textContent = 'ゲームクリア！'; 
            } else {
                icon.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                icon.style.color = '#e74c3c';
                msg.innerHTML = message; 
                closeButton.textContent = '閉じる';
            }

            modal.style.display = 'flex';
            modal.classList.remove('modal-hidden');
        }

        function closeResultModal() {
            document.getElementById('check-result-modal').classList.add('modal-hidden');
            document.getElementById('check-result-modal').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
